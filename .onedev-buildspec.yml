version: 39
properties:
- name: docker-name
  value: demo
  archived: false
- name: docker-run-command
  value: docker run -d -p 9696:9696--name demo demo
  archived: false
jobs:
- name: maven ci
  jobExecutor: local-docker
  steps:
  - !CommandStep
    name: detect build version
    runInContainer: true
    image: crpi-18z4qsjt5ze9ijn8.cn-guangzhou.personal.cr.aliyuncs.com/mealimage/cicd:1.0
    interpreter: !DefaultInterpreter
      commands: |
        echo "Detecting project version (may require some time while downloading maven dependencies)..."
        echo $(mvn org.apache.maven.plugins:maven-help-plugin:3.1.0:evaluate -Dexpression=project.version -q -DforceStdout)
    useTTY: true
    condition: ALL_PREVIOUS_STEPS_WERE_SUCCESSFUL
  - !CommandStep
    name: run unity tests
    runInContainer: true
    image: crpi-18z4qsjt5ze9ijn8.cn-guangzhou.personal.cr.aliyuncs.com/mealimage/cicd:1.0
    interpreter: !DefaultInterpreter
      commands: |
        mvn clean test
        mvn package -Dmaven.test.skip=true
        set -e
        docker build -t @property:docker-name@ .
        docker rm -f @property:docker-name@ && @property:docker-run-command@
    useTTY: true
    condition: ALL_PREVIOUS_STEPS_WERE_SUCCESSFUL
  triggers:
  - !BranchUpdateTrigger {}
  retryCondition: never
  maxRetries: 3
  retryDelay: 30
  timeout: 14400
